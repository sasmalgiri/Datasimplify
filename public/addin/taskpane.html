<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoReportKit</title>

  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    :root {
      --bg-dark: #111827;
      --bg-medium: #1F2937;
      --bg-light: #374151;
      --primary: #10B981;
      --primary-dark: #059669;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --error: #EF4444;
      --border: #374151;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: 14px;
    }

    .container { padding: 16px; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo { display: flex; align-items: center; gap: 10px; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-text h1 { font-size: 16px; font-weight: 600; }
    .logo-text p { font-size: 11px; color: var(--text-secondary); }

    .sign-out-btn {
      background: none; border: none;
      color: var(--text-muted); font-size: 12px; cursor: pointer;
    }
    .sign-out-btn:hover { color: var(--text-primary); }

    /* Sections */
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 12px; font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    /* Buttons */
    .btn {
      width: 100%; padding: 12px 16px;
      border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--bg-light); cursor: not-allowed; }

    /* Cards */
    .card {
      background: var(--bg-medium);
      border-radius: 8px; padding: 12px; margin-bottom: 8px;
    }

    /* Provider Row */
    .provider-row { display: flex; align-items: center; justify-content: space-between; }
    .provider-info { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .status-dot.connected { background: var(--primary); }
    .provider-name { font-weight: 500; }
    .provider-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
    .provider-action { background: none; border: none; font-size: 12px; cursor: pointer; }
    .provider-action.connect { color: var(--primary); }
    .provider-action.remove { color: var(--error); }

    /* Quick Insert */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .quick-btn {
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px; padding: 10px;
      color: var(--text-primary); font-size: 12px;
      text-align: left; cursor: pointer; transition: all 0.2s;
    }
    .quick-btn:hover { border-color: var(--primary); background: var(--bg-light); }

    /* Function Reference */
    .func-item {
      background: var(--bg-medium);
      border-radius: 6px; padding: 10px; margin-bottom: 6px;
      font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;
    }
    .func-name { color: var(--primary); }
    .func-example { color: var(--text-muted); margin-top: 4px; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; text-align: center;
    }
    .login-logo {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; margin-bottom: 16px;
    }
    .login-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .login-subtitle { color: var(--text-secondary); font-size: 13px; margin-bottom: 24px; }
    .login-form { width: 100%; max-width: 280px; }
    .form-group { margin-bottom: 12px; text-align: left; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 10px 12px;
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 14px;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }
    .form-input::placeholder { color: var(--text-muted); }

    .error-msg {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error); padding: 10px;
      border-radius: 6px; font-size: 12px; margin-bottom: 12px;
    }
    .signup-link { margin-top: 16px; font-size: 12px; color: var(--text-muted); }
    .signup-link a { color: var(--primary); text-decoration: none; }

    /* Key Input */
    .key-input-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .key-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .key-input {
      flex: 1; padding: 8px 10px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 12px;
    }
    .key-input:focus { outline: none; border-color: var(--primary); }
    .key-btn { padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; }
    .key-btn-save { background: var(--primary); color: white; }
    .key-btn-cancel { background: var(--bg-light); color: var(--text-secondary); }
    .key-help { font-size: 11px; color: var(--text-muted); }
    .key-help a { color: var(--primary); text-decoration: none; }

    /* Loading */
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; color: var(--text-secondary);
    }
    .spinner {
      width: 24px; height: 24px;
      border: 2px solid var(--bg-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Footer */
    .footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
    .footer a { color: var(--primary); text-decoration: none; font-size: 13px; }
    .last-refresh { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 8px; }

    .hidden { display: none !important; }
    .byok-hint { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
    .chart-btn { margin-bottom: 8px; }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingScreen" class="loading">
    <div class="spinner"></div>
    <span>Loading...</span>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen hidden">
    <div class="login-logo">ðŸ“Š</div>
    <h1 class="login-title">CryptoReportKit</h1>
    <p class="login-subtitle">Sign in to use CRK functions in Excel</p>

    <div class="login-form">
      <div id="loginError" class="error-msg hidden"></div>

      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="emailInput" class="form-input" placeholder="you@example.com">
      </div>

      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="passwordInput" class="form-input" placeholder="Enter your password">
      </div>

      <button id="loginBtn" class="btn btn-primary" onclick="handleLogin()">Sign In</button>

      <p class="signup-link">
        Don't have an account? <a href="https://cryptoreportkit.com/signup" target="_blank" rel="noopener">Sign up</a>
      </p>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">ðŸ“Š</div>
        <div class="logo-text">
          <h1>CryptoReportKit</h1>
          <p id="userEmail">user@example.com</p>
        </div>
      </div>
      <button class="sign-out-btn" onclick="handleSignOut()">Sign out</button>
    </div>

    <!-- Refresh Button -->
    <div class="section">
      <button id="refreshBtn" class="btn btn-primary" onclick="handleRefresh()">â†» Refresh All Data</button>
      <p id="lastRefresh" class="last-refresh hidden">Last refresh: --</p>
    </div>

    <!-- API Keys -->
    <div class="section">
      <div class="section-title">API Keys (BYOK)</div>
      <div class="card">
        <div class="provider-row">
          <div class="provider-info">
            <div id="cgStatus" class="status-dot"></div>
            <span class="provider-name">CoinGecko</span>
            <span id="cgHint" class="provider-hint"></span>
          </div>
          <button id="cgAction" class="provider-action connect" onclick="toggleKeyInput()">Connect</button>
        </div>

        <div id="keyInputSection" class="key-input-section hidden">
          <div class="key-input-row">
            <input type="password" id="apiKeyInput" class="key-input" placeholder="CG-xxxxxxxxxxxxxxxxxxxx">
            <button class="key-btn key-btn-save" onclick="saveApiKey()">Save</button>
            <button class="key-btn key-btn-cancel" onclick="toggleKeyInput()">Cancel</button>
          </div>
          <p class="key-help">
            <a href="https://www.coingecko.com/en/api/pricing" target="_blank" rel="noopener">Get free API key â†’</a>
          </p>
        </div>
      </div>
      <p class="byok-hint">
        Optional: Connect your own API key for higher rate limits
      </p>
    </div>

    <!-- Create Charts -->
    <div class="section">
      <div class="section-title">ðŸ“Š Create Charts</div>
      <button type="button" id="createChartsBtn" class="btn btn-primary chart-btn" onclick="createAllCharts()">
        ðŸŽ¨ Auto-Create Dashboard Charts
      </button>
      <div class="quick-grid">
        <button class="quick-btn" onclick="createChart('pie', 'marketcap')">ðŸ¥§ Market Cap Pie</button>
        <button class="quick-btn" onclick="createChart('bar', 'price')">ðŸ“Š Price Bar</button>
        <button class="quick-btn" onclick="createChart('bar', 'change')">ðŸ“ˆ 24h Change</button>
        <button class="quick-btn" onclick="createChart('line', 'price')">ðŸ“‰ Price Line</button>
      </div>
      <p class="byok-hint">Creates native Excel charts from your Data sheet</p>
    </div>

    <!-- Quick Insert -->
    <div class="section">
      <div class="section-title">Quick Insert</div>
      <div class="quick-grid">
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;bitcoin&quot;)')">BTC Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;ethereum&quot;)')">ETH Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.CHANGE24H(&quot;bitcoin&quot;)')">BTC 24h %</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.OHLCV(&quot;bitcoin&quot;,30)')">BTC OHLCV</button>
      </div>
    </div>

    <!-- Function Reference -->
    <div class="section">
      <div class="section-title">Available Functions</div>
      <div class="func-item">
        <span class="func-name">CRK.PRICE</span>(coin, [currency])
        <div class="func-example">=CRK.PRICE("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.CHANGE24H</span>(coin)
        <div class="func-example">=CRK.CHANGE24H("ethereum")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.MARKETCAP</span>(coin)
        <div class="func-example">=CRK.MARKETCAP("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.OHLCV</span>(coin, [days])
        <div class="func-example">=CRK.OHLCV("bitcoin", 30)</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.INFO</span>(coin, field)
        <div class="func-example">=CRK.INFO("bitcoin", "rank")</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <a href="https://cryptoreportkit.com/addin/docs" target="_blank" rel="noopener">View all 30+ functions â†’</a>
    </div>
  </div>

  <script>
    const API_BASE = 'https://cryptoreportkit.com';
    let currentUser = null;
    let authToken = null;
    let isOfficeReady = false;

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('[CRK] Office ready:', info.host);
      isOfficeReady = true;
      init();
    });

    // Fallback for testing outside Excel
    setTimeout(() => {
      if (!isOfficeReady) {
        console.log('[CRK] Running outside Office');
        init();
      }
    }, 2000);

    async function init() {
      // Check for stored token
      try {
        if (typeof OfficeRuntime !== 'undefined') {
          authToken = await OfficeRuntime.storage.getItem('crk_auth_token');
          const email = await OfficeRuntime.storage.getItem('crk_user_email');
          if (authToken && email) currentUser = { email };
        }
      } catch (e) {
        authToken = localStorage.getItem('crk_auth_token');
        const email = localStorage.getItem('crk_user_email');
        if (authToken && email) currentUser = { email };
      }

      document.getElementById('loadingScreen').classList.add('hidden');
      if (currentUser) {
        showMainApp();
        loadProviderStatus();
      } else {
        showLoginScreen();
      }
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    async function handleLogin() {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');

      if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Signing in...';
      errorDiv.classList.add('hidden');

      try {
        const response = await fetch(API_BASE + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Login failed');

        authToken = data.access_token;
        currentUser = { email: data.email || email };

        try {
          if (typeof OfficeRuntime !== 'undefined') {
            await OfficeRuntime.storage.setItem('crk_auth_token', authToken);
            await OfficeRuntime.storage.setItem('crk_user_email', currentUser.email);
          }
        } catch (e) {
          localStorage.setItem('crk_auth_token', authToken);
          localStorage.setItem('crk_user_email', currentUser.email);
        }

        showMainApp();
        loadProviderStatus();
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleSignOut() {
      try {
        if (typeof OfficeRuntime !== 'undefined') {
          await OfficeRuntime.storage.removeItem('crk_auth_token');
          await OfficeRuntime.storage.removeItem('crk_user_email');
        }
      } catch (e) {}
      localStorage.removeItem('crk_auth_token');
      localStorage.removeItem('crk_user_email');
      currentUser = null;
      authToken = null;
      showLoginScreen();
    }

    async function loadProviderStatus() {
      try {
        const response = await fetch(API_BASE + '/api/v1/keys/coingecko', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.ok) {
          const data = await response.json();
          const statusDot = document.getElementById('cgStatus');
          const hint = document.getElementById('cgHint');
          const action = document.getElementById('cgAction');

          if (data.connected) {
            statusDot.classList.add('connected');
            hint.textContent = 'â€¢â€¢â€¢â€¢' + (data.hint || '');
            action.textContent = 'Remove';
            action.className = 'provider-action remove';
            action.onclick = removeApiKey;
          } else {
            statusDot.classList.remove('connected');
            hint.textContent = '';
            action.textContent = 'Connect';
            action.className = 'provider-action connect';
            action.onclick = toggleKeyInput;
          }
        }
      } catch (error) {
        console.error('[CRK] Error loading provider status:', error);
      }
    }

    function toggleKeyInput() {
      const section = document.getElementById('keyInputSection');
      section.classList.toggle('hidden');
      document.getElementById('apiKeyInput').value = '';
    }

    async function saveApiKey() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) { alert('Please enter an API key'); return; }

      try {
        const response = await fetch(API_BASE + '/api/v1/keys/coingecko', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          body: JSON.stringify({ apiKey })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to save key');
        }
        toggleKeyInput();
        loadProviderStatus();
      } catch (error) {
        alert(error.message);
      }
    }

    async function removeApiKey() {
      if (!confirm('Remove your CoinGecko API key?')) return;
      try {
        await fetch(API_BASE + '/api/v1/keys/coingecko', {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        loadProviderStatus();
      } catch (error) {
        console.error('[CRK] Error removing key:', error);
      }
    }

    async function handleRefresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        if (isOfficeReady && typeof Excel !== 'undefined') {
          await Excel.run(async (context) => {
            context.workbook.application.calculate('Full');
            await context.sync();
          });
        }
        const lastRefresh = document.getElementById('lastRefresh');
        lastRefresh.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
        lastRefresh.classList.remove('hidden');
      } catch (error) {
        console.error('[CRK] Refresh error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'â†» Refresh All Data';
      }
    }

    async function insertFormula(formula) {
      if (isOfficeReady && typeof Excel !== 'undefined') {
        try {
          await Excel.run(async (context) => {
            const range = context.workbook.getSelectedRange();
            range.formulas = [[formula]];
            await context.sync();
          });
        } catch (error) {
          await navigator.clipboard.writeText(formula);
          alert('Formula copied to clipboard: ' + formula);
        }
      } else {
        await navigator.clipboard.writeText(formula);
        alert('Formula copied to clipboard: ' + formula);
      }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', () => {
      ['emailInput', 'passwordInput'].forEach(id => {
        document.getElementById(id)?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleLogin();
        });
      });
    });

    // ============================================
    // CHART CREATION FUNCTIONS (Office.js)
    // ============================================

    /**
     * Create all charts automatically (Dashboard)
     */
    async function createAllCharts() {
      const btn = document.getElementById('createChartsBtn');
      btn.disabled = true;
      btn.textContent = 'Creating charts...';

      try {
        if (!isOfficeReady || typeof Excel === 'undefined') {
          alert('Excel is not available. Please open this in Excel.');
          return;
        }

        await Excel.run(async (context) => {
          // Check if Data sheet exists
          const sheets = context.workbook.worksheets;
          sheets.load('items/name');
          await context.sync();

          const dataSheet = sheets.items.find(s => s.name === 'Data');
          if (!dataSheet) {
            alert('No "Data" sheet found. Please ensure your workbook has a Data sheet with coin data.');
            return;
          }

          // Get data range
          const usedRange = dataSheet.getUsedRange();
          usedRange.load(['rowCount', 'columnCount', 'address']);
          await context.sync();

          const rowCount = usedRange.rowCount;
          if (rowCount < 2) {
            alert('Data sheet appears empty. Please refresh data first.');
            return;
          }

          // Create or get Charts sheet
          let chartsSheet;
          const existingChartsSheet = sheets.items.find(s => s.name === 'Charts');
          if (existingChartsSheet) {
            chartsSheet = existingChartsSheet;
            chartsSheet.activate();
          } else {
            chartsSheet = sheets.add('Charts');
          }
          await context.sync();

          // Clear existing content
          chartsSheet.getRange().clear();
          await context.sync();

          // Add title
          const titleCell = chartsSheet.getRange('B2');
          titleCell.values = [['ðŸ“Š CryptoReportKit Dashboard']];
          titleCell.format.font.size = 18;
          titleCell.format.font.bold = true;
          titleCell.format.font.color = '#10B981';

          const subtitleCell = chartsSheet.getRange('B3');
          subtitleCell.values = [['Auto-generated charts from your crypto data']];
          subtitleCell.format.font.size = 11;
          subtitleCell.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Market Cap Pie Chart
          const pieChart = chartsSheet.charts.add(
            Excel.ChartType.pie,
            dataSheet.getRange('A1:A' + rowCount + ',D1:D' + rowCount), // Coin names + Market Cap
            Excel.ChartSeriesBy.columns
          );
          pieChart.setPosition('B5');
          pieChart.height = 250;
          pieChart.width = 350;
          pieChart.title.text = 'Market Cap Distribution';
          pieChart.title.format.font.size = 14;
          pieChart.title.format.font.color = '#FFFFFF';
          pieChart.format.fill.setSolidColor('#1F2937');
          pieChart.legend.position = Excel.ChartLegendPosition.right;
          pieChart.legend.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Price Bar Chart
          const barChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:B' + rowCount), // Coin names + Price
            Excel.ChartSeriesBy.columns
          );
          barChart.setPosition('I5');
          barChart.height = 250;
          barChart.width = 350;
          barChart.title.text = 'Price Comparison (USD)';
          barChart.title.format.font.size = 14;
          barChart.title.format.font.color = '#FFFFFF';
          barChart.format.fill.setSolidColor('#1F2937');
          barChart.legend.visible = false;

          // Style axes
          const barXAxis = barChart.axes.getItem(Excel.ChartAxisType.category);
          barXAxis.format.font.color = '#9CA3AF';
          const barYAxis = barChart.axes.getItem(Excel.ChartAxisType.value);
          barYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Create 24h Change Bar Chart
          const changeChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:A' + rowCount + ',C1:C' + rowCount), // Coin names + Change
            Excel.ChartSeriesBy.columns
          );
          changeChart.setPosition('B20');
          changeChart.height = 250;
          changeChart.width = 350;
          changeChart.title.text = '24h Price Change (%)';
          changeChart.title.format.font.size = 14;
          changeChart.title.format.font.color = '#FFFFFF';
          changeChart.format.fill.setSolidColor('#1F2937');
          changeChart.legend.visible = false;

          const changeXAxis = changeChart.axes.getItem(Excel.ChartAxisType.category);
          changeXAxis.format.font.color = '#9CA3AF';
          const changeYAxis = changeChart.axes.getItem(Excel.ChartAxisType.value);
          changeYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Volume Bar Chart
          const volumeChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:A' + rowCount + ',E1:E' + rowCount), // Coin names + Volume
            Excel.ChartSeriesBy.columns
          );
          volumeChart.setPosition('I20');
          volumeChart.height = 250;
          volumeChart.width = 350;
          volumeChart.title.text = '24h Trading Volume';
          volumeChart.title.format.font.size = 14;
          volumeChart.title.format.font.color = '#FFFFFF';
          volumeChart.format.fill.setSolidColor('#1F2937');
          volumeChart.legend.visible = false;

          const volXAxis = volumeChart.axes.getItem(Excel.ChartAxisType.category);
          volXAxis.format.font.color = '#9CA3AF';
          const volYAxis = volumeChart.axes.getItem(Excel.ChartAxisType.value);
          volYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Set dark background for the sheet
          chartsSheet.getRange('A1:P50').format.fill.color = '#111827';

          // Add footer note
          const footerCell = chartsSheet.getRange('B36');
          footerCell.values = [['Charts auto-update when you refresh data (Ctrl+Alt+F5)']];
          footerCell.format.font.size = 10;
          footerCell.format.font.color = '#6B7280';
          footerCell.format.font.italic = true;
          await context.sync();

          alert('Dashboard created! Check the "Charts" sheet.');
        });

      } catch (error) {
        console.error('[CRK] Chart creation error:', error);
        alert('Error creating charts: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ðŸŽ¨ Auto-Create Dashboard Charts';
      }
    }

    /**
     * Create a single chart of specified type
     */
    async function createChart(chartType, dataType) {
      try {
        if (!isOfficeReady || typeof Excel === 'undefined') {
          alert('Excel is not available. Please open this in Excel.');
          return;
        }

        await Excel.run(async (context) => {
          const sheets = context.workbook.worksheets;
          sheets.load('items/name');
          await context.sync();

          const dataSheet = sheets.items.find(s => s.name === 'Data');
          if (!dataSheet) {
            alert('No "Data" sheet found.');
            return;
          }

          const usedRange = dataSheet.getUsedRange();
          usedRange.load('rowCount');
          await context.sync();

          const rowCount = usedRange.rowCount;
          if (rowCount < 2) {
            alert('Data sheet appears empty.');
            return;
          }

          // Determine data columns based on dataType
          let dataRange;
          let chartTitle;
          switch (dataType) {
            case 'marketcap':
              dataRange = 'A1:A' + rowCount + ',D1:D' + rowCount;
              chartTitle = 'Market Cap Distribution';
              break;
            case 'price':
              dataRange = 'A1:B' + rowCount;
              chartTitle = 'Price Comparison (USD)';
              break;
            case 'change':
              dataRange = 'A1:A' + rowCount + ',C1:C' + rowCount;
              chartTitle = '24h Price Change (%)';
              break;
            default:
              dataRange = 'A1:B' + rowCount;
              chartTitle = 'Crypto Data';
          }

          // Map chart type
          let excelChartType;
          switch (chartType) {
            case 'pie':
              excelChartType = Excel.ChartType.pie;
              break;
            case 'bar':
              excelChartType = Excel.ChartType.columnClustered;
              break;
            case 'line':
              excelChartType = Excel.ChartType.line;
              break;
            default:
              excelChartType = Excel.ChartType.columnClustered;
          }

          // Create chart on active sheet
          const activeSheet = context.workbook.worksheets.getActiveWorksheet();
          const chart = activeSheet.charts.add(
            excelChartType,
            dataSheet.getRange(dataRange),
            Excel.ChartSeriesBy.columns
          );

          // Position at selection or default
          const selection = context.workbook.getSelectedRange();
          selection.load('address');
          await context.sync();

          chart.setPosition(selection);
          chart.height = 250;
          chart.width = 350;
          chart.title.text = chartTitle;
          chart.title.format.font.size = 14;
          chart.format.fill.setSolidColor('#1F2937');
          await context.sync();

          alert('Chart created: ' + chartTitle);
        });

      } catch (error) {
        console.error('[CRK] Chart error:', error);
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
