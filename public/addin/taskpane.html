<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoReportKit</title>

  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <!-- Chart.js for Advanced Visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- Financial charts (candlestick) -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
  <!-- Matrix/Heatmap plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
  <!-- Treemap plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>

  <style>
    :root {
      --bg-dark: #111827;
      --bg-medium: #1F2937;
      --bg-light: #374151;
      --primary: #10B981;
      --primary-dark: #059669;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --error: #EF4444;
      --border: #374151;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: 14px;
    }

    .container { padding: 16px; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo { display: flex; align-items: center; gap: 10px; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-text h1 { font-size: 16px; font-weight: 600; }
    .logo-text p { font-size: 11px; color: var(--text-secondary); }

    .sign-out-btn {
      background: none; border: none;
      color: var(--text-muted); font-size: 12px; cursor: pointer;
    }
    .sign-out-btn:hover { color: var(--text-primary); }

    /* Sections */
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 12px; font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    /* Buttons */
    .btn {
      width: 100%; padding: 12px 16px;
      border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--bg-light); cursor: not-allowed; }

    /* Cards */
    .card {
      background: var(--bg-medium);
      border-radius: 8px; padding: 12px; margin-bottom: 8px;
    }

    /* Provider Row */
    .provider-row { display: flex; align-items: center; justify-content: space-between; }
    .provider-info { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .status-dot.connected { background: var(--primary); }
    .provider-name { font-weight: 500; }
    .provider-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
    .provider-action { background: none; border: none; font-size: 12px; cursor: pointer; }
    .provider-action.connect { color: var(--primary); }
    .provider-action.remove { color: var(--error); }

    /* Quick Insert */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .quick-btn {
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px; padding: 10px;
      color: var(--text-primary); font-size: 12px;
      text-align: left; cursor: pointer; transition: all 0.2s;
    }
    .quick-btn:hover { border-color: var(--primary); background: var(--bg-light); }

    /* Function Reference */
    .func-item {
      background: var(--bg-medium);
      border-radius: 6px; padding: 10px; margin-bottom: 6px;
      font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;
    }
    .func-name { color: var(--primary); }
    .func-example { color: var(--text-muted); margin-top: 4px; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; text-align: center;
    }
    .login-logo {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; margin-bottom: 16px;
    }
    .login-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .login-subtitle { color: var(--text-secondary); font-size: 13px; margin-bottom: 24px; }
    .login-form { width: 100%; max-width: 280px; }
    .form-group { margin-bottom: 12px; text-align: left; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 10px 12px;
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 14px;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }
    .form-input::placeholder { color: var(--text-muted); }

    .error-msg {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error); padding: 10px;
      border-radius: 6px; font-size: 12px; margin-bottom: 12px;
    }
    .signup-link { margin-top: 16px; font-size: 12px; color: var(--text-muted); }
    .signup-link a { color: var(--primary); text-decoration: none; }

    /* Key Input */
    .key-input-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .key-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .key-input {
      flex: 1; padding: 8px 10px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 12px;
    }
    .key-input:focus { outline: none; border-color: var(--primary); }
    .key-btn { padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; }
    .key-btn-save { background: var(--primary); color: white; }
    .key-btn-cancel { background: var(--bg-light); color: var(--text-secondary); }
    .key-help { font-size: 11px; color: var(--text-muted); }
    .key-help a { color: var(--primary); text-decoration: none; }

    /* Loading */
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; color: var(--text-secondary);
    }
    .spinner {
      width: 24px; height: 24px;
      border: 2px solid var(--bg-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Footer */
    .footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
    .footer a { color: var(--primary); text-decoration: none; font-size: 13px; }
    .last-refresh { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 8px; }

    .hidden { display: none !important; }
    .byok-hint { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
    .chart-btn { margin-bottom: 8px; }

    /* Advanced Charts Section */
    .advanced-charts { margin-top: 16px; }
    .chart-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .chart-tab {
      padding: 6px 10px;
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .chart-tab:hover { border-color: var(--primary); color: var(--text-primary); }
    .chart-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .chart-container {
      background: var(--bg-medium);
      border-radius: 8px;
      padding: 16px;
      min-height: 280px;
      position: relative;
    }
    .chart-canvas-wrapper {
      position: relative;
      height: 240px;
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-badge {
      font-size: 9px;
      padding: 2px 6px;
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      border-radius: 10px;
      color: white;
      font-weight: 500;
    }
    .chart-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 12px;
    }
    .chart-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .chart-action-btn {
      flex: 1;
      padding: 8px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chart-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }
    .center-text .value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .center-text .label { font-size: 11px; color: var(--text-muted); }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingScreen" class="loading">
    <div class="spinner"></div>
    <span>Loading...</span>
  </div>

  <!-- Welcome Screen (No Login Required) -->
  <div id="welcomeScreen" class="login-screen hidden">
    <div class="login-logo">üìä</div>
    <h1 class="login-title">CryptoReportKit</h1>
    <p class="login-subtitle">Excel charting tools for your crypto data</p>

    <div class="login-form">
      <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; text-align: center;">
        Create beautiful charts from your Excel data. Your CoinGecko API key stays in your Excel file.
      </p>

      <button id="welcomeBtn" class="btn btn-primary" onclick="handleWelcome()">Open Chart Tools</button>

      <p class="signup-link" style="margin-top: 12px;">
        <a href="https://cryptoreportkit.com/byok" target="_blank" rel="noopener">BYOK Setup Guide ‚Üí</a>
      </p>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">üìä</div>
        <div class="logo-text">
          <h1>CryptoReportKit</h1>
          <p id="userEmail">Free Tier</p>
        </div>
      </div>
      <button type="button" class="sign-out-btn" onclick="handleSignOut()">Reset</button>
    </div>

    <!-- Refresh Button -->
    <div class="section">
      <button id="refreshBtn" class="btn btn-primary" onclick="handleRefresh()">‚Üª Refresh All Data</button>
      <p id="lastRefresh" class="last-refresh hidden">Last refresh: --</p>
    </div>

    <!-- BYOK Info -->
    <div class="section">
      <div class="card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
        <p style="font-size: 12px; color: #9CA3AF; margin-bottom: 8px;">
          <strong style="color: #10B981;">BYOK Model:</strong> Your CoinGecko API key stays in your Excel file.
        </p>
        <a href="https://cryptoreportkit.com/byok" target="_blank" rel="noopener" style="font-size: 11px; color: #10B981; text-decoration: none;">
          View setup guide ‚Üí
        </a>
      </div>
    </div>

    <!-- Create Charts -->
    <div class="section">
      <div class="section-title">üìä Create Excel Charts</div>
      <button type="button" id="createChartsBtn" class="btn btn-primary chart-btn" onclick="createAllCharts()">
        üé® Auto-Create Dashboard Charts
      </button>
      <div class="quick-grid">
        <button class="quick-btn" onclick="createChart('pie', 'marketcap')">ü•ß Market Cap Pie</button>
        <button class="quick-btn" onclick="createChart('bar', 'price')">üìä Price Bar</button>
        <button class="quick-btn" onclick="createChart('bar', 'change')">üìà 24h Change</button>
        <button class="quick-btn" onclick="createChart('line', 'price')">üìâ Price Line</button>
      </div>
      <p class="byok-hint">Creates native Excel charts from your Data sheet</p>
    </div>

    <!-- Advanced Charts (Chart.js) -->
    <div class="section advanced-charts">
      <div class="section-title">üöÄ Advanced Dashboard <span class="chart-badge">PRO</span></div>

      <!-- Chart Type Tabs - Row 1: Basic -->
      <div class="chart-tabs">
        <button type="button" class="chart-tab active" data-chart="radar" onclick="switchAdvancedChart('radar')">üéØ Radar</button>
        <button type="button" class="chart-tab" data-chart="doughnut" onclick="switchAdvancedChart('doughnut')">üç© Doughnut</button>
        <button type="button" class="chart-tab" data-chart="bubble" onclick="switchAdvancedChart('bubble')">üí≠ Bubble</button>
        <button type="button" class="chart-tab" data-chart="polar" onclick="switchAdvancedChart('polar')">üåê Polar</button>
        <button type="button" class="chart-tab" data-chart="gradient" onclick="switchAdvancedChart('gradient')">üìà Gradient</button>
        <button type="button" class="chart-tab" data-chart="mixed" onclick="switchAdvancedChart('mixed')">üîÄ Mixed</button>
      </div>
      <!-- Chart Type Tabs - Row 2: Advanced -->
      <div class="chart-tabs">
        <button type="button" class="chart-tab" data-chart="candlestick" onclick="switchAdvancedChart('candlestick')">üïØÔ∏è Candle</button>
        <button type="button" class="chart-tab" data-chart="gauge" onclick="switchAdvancedChart('gauge')">üå°Ô∏è Gauge</button>
        <button type="button" class="chart-tab" data-chart="heatmap" onclick="switchAdvancedChart('heatmap')">üó∫Ô∏è Heatmap</button>
        <button type="button" class="chart-tab" data-chart="treemap" onclick="switchAdvancedChart('treemap')">üì¶ Treemap</button>
        <button type="button" class="chart-tab" data-chart="stacked" onclick="switchAdvancedChart('stacked')">üìä Stacked</button>
        <button type="button" class="chart-tab" data-chart="scatter" onclick="switchAdvancedChart('scatter')">üé® Scatter</button>
      </div>

      <!-- Chart Container -->
      <div class="chart-container">
        <div class="chart-title" id="advancedChartTitle">
          üéØ Multi-Metric Radar Analysis
        </div>
        <div class="chart-canvas-wrapper">
          <canvas id="advancedChart"></canvas>
          <div class="chart-loading" id="chartLoading">Loading data from Excel...</div>
          <!-- Center text for doughnut -->
          <div class="center-text hidden" id="doughnutCenter">
            <div class="value" id="centerValue">$0</div>
            <div class="label">Total Market Cap</div>
          </div>
        </div>
        <div class="chart-actions">
          <button type="button" class="chart-action-btn" onclick="refreshAdvancedChart()">‚Üª Refresh</button>
          <button type="button" class="chart-action-btn" onclick="downloadChartImage()">üì• Download PNG</button>
          <button type="button" class="chart-action-btn" onclick="toggleChartAnimation()">‚ú® Animate</button>
        </div>
      </div>
      <p class="byok-hint">Advanced visualizations powered by Chart.js ‚Ä¢ Data from your Excel sheet</p>
    </div>

    <!-- Quick Insert -->
    <div class="section">
      <div class="section-title">Quick Insert</div>
      <div class="quick-grid">
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;bitcoin&quot;)')">BTC Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;ethereum&quot;)')">ETH Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.CHANGE24H(&quot;bitcoin&quot;)')">BTC 24h %</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.OHLCV(&quot;bitcoin&quot;,30)')">BTC OHLCV</button>
      </div>
    </div>

    <!-- Function Reference -->
    <div class="section">
      <div class="section-title">Available Functions</div>
      <div class="func-item">
        <span class="func-name">CRK.PRICE</span>(coin, [currency])
        <div class="func-example">=CRK.PRICE("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.CHANGE24H</span>(coin)
        <div class="func-example">=CRK.CHANGE24H("ethereum")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.MARKETCAP</span>(coin)
        <div class="func-example">=CRK.MARKETCAP("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.OHLCV</span>(coin, [days])
        <div class="func-example">=CRK.OHLCV("bitcoin", 30)</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.INFO</span>(coin, field)
        <div class="func-example">=CRK.INFO("bitcoin", "rank")</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <a href="https://cryptoreportkit.com/addin/docs" target="_blank" rel="noopener">View all 30+ functions ‚Üí</a>
    </div>
  </div>

  <script>
    // CRK Taskpane - Chart tools for Excel
    const SETUP_COMPLETE = 'crk_setup_complete';
    let isOfficeReady = false;

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('[CRK] Office ready:', info.host);
      isOfficeReady = true;
      init();
    });

    // Fallback for testing outside Excel
    setTimeout(() => {
      if (!isOfficeReady) {
        console.log('[CRK] Running outside Office');
        init();
      }
    }, 2000);

    async function init() {
      const setupComplete = await getStorageItem(SETUP_COMPLETE);

      document.getElementById('loadingScreen').classList.add('hidden');

      if (setupComplete) {
        showMainApp();
      } else {
        showWelcomeScreen();
      }
    }

    // Storage helpers that work with both OfficeRuntime and localStorage
    async function getStorageItem(key) {
      try {
        if (typeof OfficeRuntime !== 'undefined' && OfficeRuntime.storage) {
          return await OfficeRuntime.storage.getItem(key);
        }
      } catch (e) {}
      try {
        return localStorage.getItem(key);
      } catch (e) {
        return null;
      }
    }

    async function setStorageItem(key, value) {
      try {
        if (typeof OfficeRuntime !== 'undefined' && OfficeRuntime.storage) {
          await OfficeRuntime.storage.setItem(key, value);
        }
      } catch (e) {}
      try {
        localStorage.setItem(key, value);
      } catch (e) {}
    }

    async function removeStorageItem(key) {
      try {
        if (typeof OfficeRuntime !== 'undefined' && OfficeRuntime.storage) {
          await OfficeRuntime.storage.removeItem(key);
        }
      } catch (e) {}
      try {
        localStorage.removeItem(key);
      } catch (e) {}
    }

    function showWelcomeScreen() {
      document.getElementById('welcomeScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Update display
      document.getElementById('userEmail').textContent = 'Chart Tools Ready';

      // Initialize advanced Chart.js visualization
      setTimeout(() => renderAdvancedChart('radar'), 500);
    }

    async function handleWelcome() {
      const btn = document.getElementById('welcomeBtn');
      btn.disabled = true;
      btn.textContent = 'Loading...';

      // Mark setup as complete
      await setStorageItem(SETUP_COMPLETE, 'true');
      showMainApp();

      btn.disabled = false;
      btn.textContent = 'Open Chart Tools';
    }

    async function handleSignOut() {
      // Clear stored data and return to welcome screen
      await removeStorageItem(SETUP_COMPLETE);
      showWelcomeScreen();
    }

    async function handleRefresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        if (isOfficeReady && typeof Excel !== 'undefined') {
          await Excel.run(async (context) => {
            context.workbook.application.calculate('Full');
            await context.sync();
          });
        }
        const lastRefresh = document.getElementById('lastRefresh');
        lastRefresh.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
        lastRefresh.classList.remove('hidden');
      } catch (error) {
        console.error('[CRK] Refresh error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = '‚Üª Refresh All Data';
      }
    }

    async function insertFormula(formula) {
      if (isOfficeReady && typeof Excel !== 'undefined') {
        try {
          await Excel.run(async (context) => {
            const range = context.workbook.getSelectedRange();
            range.formulas = [[formula]];
            await context.sync();
          });
        } catch (error) {
          await navigator.clipboard.writeText(formula);
          alert('Formula copied to clipboard: ' + formula);
        }
      } else {
        await navigator.clipboard.writeText(formula);
        alert('Formula copied to clipboard: ' + formula);
      }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', () => {
      ['emailInput', 'passwordInput'].forEach(id => {
        document.getElementById(id)?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleLogin();
        });
      });
    });

    // ============================================
    // CHART CREATION FUNCTIONS (Office.js)
    // ============================================

    /**
     * Create all charts automatically (Dashboard)
     */
    async function createAllCharts() {
      const btn = document.getElementById('createChartsBtn');
      btn.disabled = true;
      btn.textContent = 'Creating charts...';

      try {
        if (!isOfficeReady || typeof Excel === 'undefined') {
          alert('Excel is not available. Please open this in Excel.');
          return;
        }

        await Excel.run(async (context) => {
          // Check if Data sheet exists
          const sheets = context.workbook.worksheets;
          sheets.load('items/name');
          await context.sync();

          const dataSheet = sheets.items.find(s => s.name === 'Data');
          if (!dataSheet) {
            alert('No "Data" sheet found. Please ensure your workbook has a Data sheet with coin data.');
            return;
          }

          // Get data range
          const usedRange = dataSheet.getUsedRange();
          usedRange.load(['rowCount', 'columnCount', 'address']);
          await context.sync();

          const rowCount = usedRange.rowCount;
          if (rowCount < 2) {
            alert('Data sheet appears empty. Please refresh data first.');
            return;
          }

          // Create or get Charts sheet
          let chartsSheet;
          const existingChartsSheet = sheets.items.find(s => s.name === 'Charts');
          if (existingChartsSheet) {
            chartsSheet = existingChartsSheet;
            chartsSheet.activate();
          } else {
            chartsSheet = sheets.add('Charts');
          }
          await context.sync();

          // Clear existing content
          chartsSheet.getRange().clear();
          await context.sync();

          // Add title
          const titleCell = chartsSheet.getRange('B2');
          titleCell.values = [['üìä CryptoReportKit Dashboard']];
          titleCell.format.font.size = 18;
          titleCell.format.font.bold = true;
          titleCell.format.font.color = '#10B981';

          const subtitleCell = chartsSheet.getRange('B3');
          subtitleCell.values = [['Auto-generated charts from your crypto data']];
          subtitleCell.format.font.size = 11;
          subtitleCell.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Market Cap Pie Chart
          const pieChart = chartsSheet.charts.add(
            Excel.ChartType.pie,
            dataSheet.getRange('A1:A' + rowCount + ',D1:D' + rowCount), // Coin names + Market Cap
            Excel.ChartSeriesBy.columns
          );
          pieChart.setPosition('B5');
          pieChart.height = 250;
          pieChart.width = 350;
          pieChart.title.text = 'Market Cap Distribution';
          pieChart.title.format.font.size = 14;
          pieChart.title.format.font.color = '#FFFFFF';
          pieChart.format.fill.setSolidColor('#1F2937');
          pieChart.legend.position = Excel.ChartLegendPosition.right;
          pieChart.legend.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Price Bar Chart
          const barChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:B' + rowCount), // Coin names + Price
            Excel.ChartSeriesBy.columns
          );
          barChart.setPosition('I5');
          barChart.height = 250;
          barChart.width = 350;
          barChart.title.text = 'Price Comparison (USD)';
          barChart.title.format.font.size = 14;
          barChart.title.format.font.color = '#FFFFFF';
          barChart.format.fill.setSolidColor('#1F2937');
          barChart.legend.visible = false;

          // Style axes
          const barXAxis = barChart.axes.getItem(Excel.ChartAxisType.category);
          barXAxis.format.font.color = '#9CA3AF';
          const barYAxis = barChart.axes.getItem(Excel.ChartAxisType.value);
          barYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Create 24h Change Bar Chart
          const changeChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:A' + rowCount + ',C1:C' + rowCount), // Coin names + Change
            Excel.ChartSeriesBy.columns
          );
          changeChart.setPosition('B20');
          changeChart.height = 250;
          changeChart.width = 350;
          changeChart.title.text = '24h Price Change (%)';
          changeChart.title.format.font.size = 14;
          changeChart.title.format.font.color = '#FFFFFF';
          changeChart.format.fill.setSolidColor('#1F2937');
          changeChart.legend.visible = false;

          const changeXAxis = changeChart.axes.getItem(Excel.ChartAxisType.category);
          changeXAxis.format.font.color = '#9CA3AF';
          const changeYAxis = changeChart.axes.getItem(Excel.ChartAxisType.value);
          changeYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Create Volume Bar Chart
          const volumeChart = chartsSheet.charts.add(
            Excel.ChartType.columnClustered,
            dataSheet.getRange('A1:A' + rowCount + ',E1:E' + rowCount), // Coin names + Volume
            Excel.ChartSeriesBy.columns
          );
          volumeChart.setPosition('I20');
          volumeChart.height = 250;
          volumeChart.width = 350;
          volumeChart.title.text = '24h Trading Volume';
          volumeChart.title.format.font.size = 14;
          volumeChart.title.format.font.color = '#FFFFFF';
          volumeChart.format.fill.setSolidColor('#1F2937');
          volumeChart.legend.visible = false;

          const volXAxis = volumeChart.axes.getItem(Excel.ChartAxisType.category);
          volXAxis.format.font.color = '#9CA3AF';
          const volYAxis = volumeChart.axes.getItem(Excel.ChartAxisType.value);
          volYAxis.format.font.color = '#9CA3AF';
          await context.sync();

          // Set dark background for the sheet
          chartsSheet.getRange('A1:P50').format.fill.color = '#111827';

          // Add footer note
          const footerCell = chartsSheet.getRange('B36');
          footerCell.values = [['Charts auto-update when you refresh data (Ctrl+Alt+F5)']];
          footerCell.format.font.size = 10;
          footerCell.format.font.color = '#6B7280';
          footerCell.format.font.italic = true;
          await context.sync();

          alert('Dashboard created! Check the "Charts" sheet.');
        });

      } catch (error) {
        console.error('[CRK] Chart creation error:', error);
        alert('Error creating charts: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üé® Auto-Create Dashboard Charts';
      }
    }

    // ============================================
    // ADVANCED CHART.JS CHARTS
    // ============================================

    let advancedChartInstance = null;
    let currentChartType = 'radar';
    let cachedExcelData = null;

    // Professional color palettes
    const CHART_COLORS = {
      primary: ['#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#EF4444', '#06B6D4', '#84CC16'],
      gradient: {
        green: ['rgba(16, 185, 129, 0.8)', 'rgba(16, 185, 129, 0.1)'],
        blue: ['rgba(59, 130, 246, 0.8)', 'rgba(59, 130, 246, 0.1)'],
        purple: ['rgba(139, 92, 246, 0.8)', 'rgba(139, 92, 246, 0.1)'],
        pink: ['rgba(236, 72, 153, 0.8)', 'rgba(236, 72, 153, 0.1)']
      }
    };

    // Chart configurations for each type
    const CHART_CONFIGS = {
      radar: {
        title: 'üéØ Multi-Metric Radar Analysis',
        description: 'Compare coins across multiple metrics'
      },
      doughnut: {
        title: 'üç© Market Distribution',
        description: 'Market cap breakdown with center stats'
      },
      bubble: {
        title: 'üí≠ Volume-Price-Cap Bubble',
        description: 'Three-dimensional market analysis'
      },
      polar: {
        title: 'üåê Polar Area Chart',
        description: 'Radial market comparison'
      },
      gradient: {
        title: 'üìà Gradient Area Chart',
        description: 'Beautiful gradient visualization'
      },
      mixed: {
        title: 'üîÄ Mixed Chart (Bar + Line)',
        description: 'Combined chart types for correlation'
      },
      // Advanced charts
      candlestick: {
        title: 'üïØÔ∏è Candlestick OHLC Chart',
        description: 'Professional trading price action'
      },
      gauge: {
        title: 'üå°Ô∏è Gauge Indicator',
        description: 'Fear & Greed / RSI speedometer'
      },
      heatmap: {
        title: 'üó∫Ô∏è Performance Heatmap',
        description: 'Sector and coin performance grid'
      },
      treemap: {
        title: 'üì¶ Market Cap Treemap',
        description: 'Hierarchical market visualization'
      },
      stacked: {
        title: 'üìä Stacked Area Chart',
        description: 'Portfolio allocation over time'
      },
      scatter: {
        title: 'üé® Correlation Scatter',
        description: 'Price vs volume correlation'
      }
    };

    /**
     * Read crypto data from Excel Data sheet
     */
    async function readExcelData() {
      if (!isOfficeReady || typeof Excel === 'undefined') {
        // Return sample data for testing outside Excel
        return getSampleData();
      }

      try {
        return await Excel.run(async (context) => {
          const sheets = context.workbook.worksheets;
          sheets.load('items/name');
          await context.sync();

          const dataSheet = sheets.items.find(s => s.name === 'Data');
          if (!dataSheet) {
            console.log('[CRK] No Data sheet found, using sample data');
            return getSampleData();
          }

          const usedRange = dataSheet.getUsedRange();
          usedRange.load(['values', 'rowCount', 'columnCount']);
          await context.sync();

          const values = usedRange.values;
          if (values.length < 2) return getSampleData();

          // Parse Excel data (assuming columns: Coin, Price, Change24h, MarketCap, Volume)
          const headers = values[0];
          const data = [];

          for (let i = 1; i < values.length; i++) {
            const row = values[i];
            data.push({
              name: row[0] || 'Unknown',
              price: parseFloat(row[1]) || 0,
              change24h: parseFloat(row[2]) || 0,
              marketCap: parseFloat(row[3]) || 0,
              volume: parseFloat(row[4]) || 0
            });
          }

          cachedExcelData = data;
          return data;
        });
      } catch (error) {
        console.error('[CRK] Error reading Excel:', error);
        return getSampleData();
      }
    }

    /**
     * Sample data for testing/demo
     */
    function getSampleData() {
      return [
        { name: 'Bitcoin', price: 67500, change24h: 2.5, marketCap: 1320000000000, volume: 28000000000 },
        { name: 'Ethereum', price: 3450, change24h: 1.8, marketCap: 415000000000, volume: 15000000000 },
        { name: 'BNB', price: 580, change24h: -0.5, marketCap: 89000000000, volume: 1200000000 },
        { name: 'Solana', price: 145, change24h: 4.2, marketCap: 62000000000, volume: 2800000000 },
        { name: 'XRP', price: 0.52, change24h: -1.2, marketCap: 28000000000, volume: 1100000000 }
      ];
    }

    /**
     * Switch between chart types
     */
    async function switchAdvancedChart(chartType) {
      currentChartType = chartType;

      // Update tab UI
      document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.chart === chartType);
      });

      // Update title
      const config = CHART_CONFIGS[chartType];
      document.getElementById('advancedChartTitle').textContent = config.title;

      // Show/hide doughnut center text
      document.getElementById('doughnutCenter').classList.toggle('hidden', chartType !== 'doughnut');

      // Render chart
      await renderAdvancedChart(chartType);
    }

    /**
     * Main chart rendering function
     */
    async function renderAdvancedChart(chartType) {
      const loading = document.getElementById('chartLoading');
      loading.classList.remove('hidden');

      // Destroy existing chart
      if (advancedChartInstance) {
        advancedChartInstance.destroy();
        advancedChartInstance = null;
      }

      // Get data
      const data = await readExcelData();
      loading.classList.add('hidden');

      const ctx = document.getElementById('advancedChart').getContext('2d');

      switch (chartType) {
        case 'radar':
          advancedChartInstance = createRadarChart(ctx, data);
          break;
        case 'doughnut':
          advancedChartInstance = createDoughnutChart(ctx, data);
          break;
        case 'bubble':
          advancedChartInstance = createBubbleChart(ctx, data);
          break;
        case 'polar':
          advancedChartInstance = createPolarChart(ctx, data);
          break;
        case 'gradient':
          advancedChartInstance = createGradientChart(ctx, data);
          break;
        case 'mixed':
          advancedChartInstance = createMixedChart(ctx, data);
          break;
        // Advanced charts
        case 'candlestick':
          advancedChartInstance = createCandlestickChart(ctx, data);
          break;
        case 'gauge':
          advancedChartInstance = createGaugeChart(ctx, data);
          break;
        case 'heatmap':
          advancedChartInstance = createHeatmapChart(ctx, data);
          break;
        case 'treemap':
          advancedChartInstance = createTreemapChart(ctx, data);
          break;
        case 'stacked':
          advancedChartInstance = createStackedAreaChart(ctx, data);
          break;
        case 'scatter':
          advancedChartInstance = createScatterChart(ctx, data);
          break;
      }
    }

    /**
     * RADAR CHART - Multi-metric comparison
     */
    function createRadarChart(ctx, data) {
      // Normalize data for radar (0-100 scale)
      const maxPrice = Math.max(...data.map(d => d.price));
      const maxMarketCap = Math.max(...data.map(d => d.marketCap));
      const maxVolume = Math.max(...data.map(d => d.volume));

      const datasets = data.slice(0, 5).map((coin, i) => ({
        label: coin.name,
        data: [
          (coin.price / maxPrice) * 100,
          Math.min(100, Math.max(0, coin.change24h + 50)), // Normalize change to 0-100
          (coin.marketCap / maxMarketCap) * 100,
          (coin.volume / maxVolume) * 100,
          Math.random() * 100 // Simulated metric (could be RSI, etc.)
        ],
        backgroundColor: CHART_COLORS.primary[i] + '33',
        borderColor: CHART_COLORS.primary[i],
        borderWidth: 2,
        pointBackgroundColor: CHART_COLORS.primary[i],
        pointRadius: 4,
        pointHoverRadius: 6
      }));

      return new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Price', '24h Momentum', 'Market Cap', 'Volume', 'Strength'],
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12 }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#6B7280', backdropColor: 'transparent', font: { size: 9 } },
              grid: { color: '#374151' },
              angleLines: { color: '#374151' },
              pointLabels: { color: '#9CA3AF', font: { size: 10 } }
            }
          },
          animation: { duration: 1000, easing: 'easeOutQuart' }
        }
      });
    }

    /**
     * DOUGHNUT CHART - With center statistics
     */
    function createDoughnutChart(ctx, data) {
      const totalMarketCap = data.reduce((sum, d) => sum + d.marketCap, 0);

      // Update center text
      document.getElementById('centerValue').textContent = formatLargeNumber(totalMarketCap);

      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(d => d.name),
          datasets: [{
            data: data.map(d => d.marketCap),
            backgroundColor: CHART_COLORS.primary.slice(0, data.length),
            borderColor: '#1F2937',
            borderWidth: 3,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12, padding: 8 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${formatLargeNumber(ctx.raw)}`
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1200
          }
        }
      });
    }

    /**
     * BUBBLE CHART - 3D visualization (X: Price, Y: Change, Size: Volume)
     */
    function createBubbleChart(ctx, data) {
      const maxVolume = Math.max(...data.map(d => d.volume));

      const bubbleData = data.map((coin, i) => ({
        x: Math.log10(coin.price + 1) * 10, // Log scale for price
        y: coin.change24h,
        r: Math.sqrt(coin.volume / maxVolume) * 30 + 5 // Size by volume
      }));

      return new Chart(ctx, {
        type: 'bubble',
        data: {
          datasets: data.map((coin, i) => ({
            label: coin.name,
            data: [bubbleData[i]],
            backgroundColor: CHART_COLORS.primary[i] + 'CC',
            borderColor: CHART_COLORS.primary[i],
            borderWidth: 2
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const coin = data[ctx.datasetIndex];
                  return [
                    `${coin.name}`,
                    `Price: $${coin.price.toLocaleString()}`,
                    `24h: ${coin.change24h > 0 ? '+' : ''}${coin.change24h.toFixed(2)}%`,
                    `Volume: ${formatLargeNumber(coin.volume)}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Price (log scale)', color: '#9CA3AF' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y: {
              title: { display: true, text: '24h Change (%)', color: '#9CA3AF' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            }
          },
          animation: { duration: 1500, easing: 'easeOutBounce' }
        }
      });
    }

    /**
     * POLAR AREA CHART - Radial comparison
     */
    function createPolarChart(ctx, data) {
      return new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: data.map(d => d.name),
          datasets: [{
            data: data.map(d => Math.log10(d.marketCap)),
            backgroundColor: CHART_COLORS.primary.map(c => c + 'AA'),
            borderColor: CHART_COLORS.primary,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const coin = data[ctx.dataIndex];
                  return `${coin.name}: ${formatLargeNumber(coin.marketCap)}`;
                }
              }
            }
          },
          scales: {
            r: {
              ticks: { color: '#6B7280', backdropColor: 'transparent' },
              grid: { color: '#374151' }
            }
          },
          animation: { animateRotate: true, animateScale: true, duration: 1000 }
        }
      });
    }

    /**
     * GRADIENT AREA CHART - Beautiful gradient fills
     */
    function createGradientChart(ctx, data) {
      // Create gradient
      const gradient1 = ctx.createLinearGradient(0, 0, 0, 200);
      gradient1.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
      gradient1.addColorStop(1, 'rgba(16, 185, 129, 0.05)');

      const gradient2 = ctx.createLinearGradient(0, 0, 0, 200);
      gradient2.addColorStop(0, 'rgba(59, 130, 246, 0.6)');
      gradient2.addColorStop(1, 'rgba(59, 130, 246, 0.05)');

      // Simulate price history (normalize to show trend)
      const priceData = data.slice(0, 2).map((coin, idx) => {
        const basePrice = coin.price;
        return {
          label: coin.name,
          data: Array.from({ length: 7 }, (_, i) =>
            basePrice * (0.9 + Math.random() * 0.2) * (1 + i * 0.02)
          ),
          backgroundColor: idx === 0 ? gradient1 : gradient2,
          borderColor: idx === 0 ? '#10B981' : '#3B82F6',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: idx === 0 ? '#10B981' : '#3B82F6',
          pointBorderColor: '#1F2937',
          pointBorderWidth: 2
        };
      });

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
          datasets: priceData
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#9CA3AF', font: { size: 11 }, boxWidth: 15 }
            }
          },
          scales: {
            x: {
              ticks: { color: '#6B7280' },
              grid: { color: '#374151', drawBorder: false }
            },
            y: {
              ticks: { color: '#6B7280', callback: (v) => '$' + v.toLocaleString() },
              grid: { color: '#374151', drawBorder: false }
            }
          },
          animation: { duration: 1500, easing: 'easeInOutQuart' }
        }
      });
    }

    /**
     * MIXED CHART - Bar + Line combination
     */
    function createMixedChart(ctx, data) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.name),
          datasets: [
            {
              type: 'bar',
              label: 'Market Cap (B)',
              data: data.map(d => d.marketCap / 1e9),
              backgroundColor: CHART_COLORS.primary.map(c => c + 'AA'),
              borderColor: CHART_COLORS.primary,
              borderWidth: 2,
              borderRadius: 6,
              yAxisID: 'y'
            },
            {
              type: 'line',
              label: '24h Change %',
              data: data.map(d => d.change24h),
              borderColor: '#F59E0B',
              backgroundColor: '#F59E0B',
              borderWidth: 3,
              pointRadius: 5,
              pointBackgroundColor: '#F59E0B',
              pointBorderColor: '#1F2937',
              pointBorderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12 }
            }
          },
          scales: {
            x: {
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Market Cap (B)', color: '#9CA3AF' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              title: { display: true, text: '24h Change %', color: '#F59E0B' },
              ticks: { color: '#F59E0B' },
              grid: { drawOnChartArea: false }
            }
          },
          animation: { duration: 1000 }
        }
      });
    }

    // ============================================
    // ADVANCED CHART TYPES
    // ============================================

    /**
     * CANDLESTICK CHART - OHLC Trading Chart
     */
    function createCandlestickChart(ctx, data) {
      // Generate OHLC data for the top coin
      const coin = data[0] || { name: 'Bitcoin', price: 67500 };
      const basePrice = coin.price;

      // Generate 30 days of OHLC data
      const ohlcData = [];
      let currentPrice = basePrice * 0.9;
      const now = Date.now();

      for (let i = 29; i >= 0; i--) {
        const volatility = 0.03 + Math.random() * 0.02;
        const trend = (Math.random() - 0.48) * volatility;

        const open = currentPrice;
        const close = open * (1 + trend);
        const high = Math.max(open, close) * (1 + Math.random() * volatility * 0.5);
        const low = Math.min(open, close) * (1 - Math.random() * volatility * 0.5);

        ohlcData.push({
          x: now - (i * 24 * 60 * 60 * 1000),
          o: open,
          h: high,
          l: low,
          c: close
        });

        currentPrice = close;
      }

      return new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: coin.name + ' OHLC',
            data: ohlcData,
            color: {
              up: '#10B981',
              down: '#EF4444',
              unchanged: '#6B7280'
            },
            borderColor: {
              up: '#10B981',
              down: '#EF4444',
              unchanged: '#6B7280'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const d = ctx.raw;
                  return [
                    `Open: $${d.o.toLocaleString()}`,
                    `High: $${d.h.toLocaleString()}`,
                    `Low: $${d.l.toLocaleString()}`,
                    `Close: $${d.c.toLocaleString()}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y: {
              ticks: {
                color: '#6B7280',
                callback: (v) => '$' + v.toLocaleString()
              },
              grid: { color: '#374151' }
            }
          }
        }
      });
    }

    /**
     * GAUGE CHART - Fear & Greed / RSI Speedometer
     */
    function createGaugeChart(ctx, data) {
      // Simulate Fear & Greed Index (0-100)
      const fearGreedValue = Math.floor(Math.random() * 100);
      const classification = fearGreedValue < 25 ? 'Extreme Fear' :
                            fearGreedValue < 45 ? 'Fear' :
                            fearGreedValue < 55 ? 'Neutral' :
                            fearGreedValue < 75 ? 'Greed' : 'Extreme Greed';

      const gaugeColor = fearGreedValue < 25 ? '#EF4444' :
                        fearGreedValue < 45 ? '#F59E0B' :
                        fearGreedValue < 55 ? '#6B7280' :
                        fearGreedValue < 75 ? '#84CC16' : '#10B981';

      // Create gauge using doughnut with rotation
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Value', 'Remaining'],
          datasets: [{
            data: [fearGreedValue, 100 - fearGreedValue],
            backgroundColor: [gaugeColor, '#374151'],
            borderWidth: 0,
            circumference: 180,
            rotation: 270
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '75%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        },
        plugins: [{
          id: 'gaugeText',
          afterDraw: (chart) => {
            const { ctx, width, height } = chart;
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Value
            ctx.font = 'bold 32px sans-serif';
            ctx.fillStyle = gaugeColor;
            ctx.fillText(fearGreedValue, width / 2, height / 2 + 20);

            // Label
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#9CA3AF';
            ctx.fillText(classification, width / 2, height / 2 + 50);

            // Title
            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#6B7280';
            ctx.fillText('Fear & Greed Index', width / 2, height / 2 + 70);

            ctx.restore();
          }
        }]
      });
    }

    /**
     * HEATMAP CHART - Performance Grid
     */
    function createHeatmapChart(ctx, data) {
      // Create performance heatmap data
      const timeframes = ['1h', '24h', '7d', '30d'];
      const heatmapData = [];

      data.slice(0, 6).forEach((coin, coinIndex) => {
        timeframes.forEach((tf, tfIndex) => {
          const change = (Math.random() - 0.5) * 20; // -10% to +10%
          heatmapData.push({
            x: tfIndex,
            y: coinIndex,
            v: change
          });
        });
      });

      return new Chart(ctx, {
        type: 'matrix',
        data: {
          datasets: [{
            label: 'Performance',
            data: heatmapData,
            backgroundColor: (ctx) => {
              const value = ctx.raw?.v || 0;
              if (value > 5) return '#10B981';
              if (value > 2) return '#34D399';
              if (value > 0) return '#6EE7B7';
              if (value > -2) return '#FCA5A5';
              if (value > -5) return '#F87171';
              return '#EF4444';
            },
            width: ({ chart }) => (chart.chartArea?.width || 200) / 4 - 4,
            height: ({ chart }) => (chart.chartArea?.height || 150) / Math.min(data.length, 6) - 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: () => '',
                label: (ctx) => {
                  const coin = data[ctx.raw.y]?.name || 'Coin';
                  const tf = timeframes[ctx.raw.x];
                  const val = ctx.raw.v.toFixed(2);
                  return `${coin} (${tf}): ${val > 0 ? '+' : ''}${val}%`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'category',
              labels: timeframes,
              ticks: { color: '#9CA3AF' },
              grid: { display: false }
            },
            y: {
              type: 'category',
              labels: data.slice(0, 6).map(d => d.name.substring(0, 6)),
              offset: true,
              ticks: { color: '#9CA3AF' },
              grid: { display: false }
            }
          }
        }
      });
    }

    /**
     * TREEMAP CHART - Market Cap Hierarchy
     */
    function createTreemapChart(ctx, data) {
      const treemapData = data.map(coin => ({
        name: coin.name,
        value: coin.marketCap,
        change: coin.change24h
      }));

      return new Chart(ctx, {
        type: 'treemap',
        data: {
          datasets: [{
            label: 'Market Cap',
            tree: treemapData,
            key: 'value',
            labels: {
              display: true,
              formatter: (ctx) => ctx.raw._data?.name || ''
            },
            backgroundColor: (ctx) => {
              const change = ctx.raw?._data?.change || 0;
              if (change > 3) return '#10B981';
              if (change > 0) return '#34D399';
              if (change > -3) return '#F87171';
              return '#EF4444';
            },
            borderColor: '#1F2937',
            borderWidth: 2,
            spacing: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => items[0]?.raw?._data?.name || '',
                label: (ctx) => {
                  const d = ctx.raw._data;
                  return [
                    `Market Cap: ${formatLargeNumber(d.value)}`,
                    `24h: ${d.change > 0 ? '+' : ''}${d.change.toFixed(2)}%`
                  ];
                }
              }
            }
          }
        }
      });
    }

    /**
     * STACKED AREA CHART - Portfolio Allocation
     */
    function createStackedAreaChart(ctx, data) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      // Generate portfolio allocation data
      const datasets = data.slice(0, 4).map((coin, i) => {
        const baseAllocation = (4 - i) * 15 + Math.random() * 10;
        return {
          label: coin.name,
          data: days.map(() => baseAllocation + (Math.random() - 0.5) * 5),
          backgroundColor: CHART_COLORS.primary[i] + 'CC',
          borderColor: CHART_COLORS.primary[i],
          borderWidth: 2,
          fill: true
        };
      });

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: days,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 12 }
            },
            tooltip: {
              mode: 'index',
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y: {
              stacked: true,
              ticks: {
                color: '#6B7280',
                callback: (v) => v + '%'
              },
              grid: { color: '#374151' }
            }
          },
          interaction: { intersect: false, mode: 'index' },
          elements: {
            line: { tension: 0.4 },
            point: { radius: 0 }
          }
        }
      });
    }

    /**
     * SCATTER CHART - Price vs Volume Correlation
     */
    function createScatterChart(ctx, data) {
      const maxVolume = Math.max(...data.map(d => d.volume));

      const scatterData = data.map((coin, i) => ({
        x: Math.log10(coin.price + 1),
        y: Math.log10(coin.volume + 1),
        label: coin.name
      }));

      return new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Price vs Volume',
            data: scatterData,
            backgroundColor: CHART_COLORS.primary.map(c => c + 'CC'),
            borderColor: CHART_COLORS.primary,
            borderWidth: 2,
            pointRadius: 8,
            pointHoverRadius: 12
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const coin = data[ctx.dataIndex];
                  return [
                    coin.name,
                    `Price: $${coin.price.toLocaleString()}`,
                    `Volume: ${formatLargeNumber(coin.volume)}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Price (log scale)', color: '#9CA3AF' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            },
            y: {
              title: { display: true, text: 'Volume (log scale)', color: '#9CA3AF' },
              ticks: { color: '#6B7280' },
              grid: { color: '#374151' }
            }
          },
          animation: { duration: 1000, easing: 'easeOutQuart' }
        }
      });
    }

    /**
     * Format large numbers (1.2T, 450B, etc.)
     */
    function formatLargeNumber(num) {
      if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
      if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
      return '$' + num.toLocaleString();
    }

    /**
     * Refresh current chart
     */
    async function refreshAdvancedChart() {
      cachedExcelData = null;
      await renderAdvancedChart(currentChartType);
    }

    /**
     * Download chart as PNG
     */
    function downloadChartImage() {
      const canvas = document.getElementById('advancedChart');
      const link = document.createElement('a');
      link.download = `crk-${currentChartType}-chart.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    /**
     * Toggle chart animation
     */
    function toggleChartAnimation() {
      if (advancedChartInstance) {
        advancedChartInstance.reset();
        advancedChartInstance.update('active');
      }
    }

    // Initialize advanced chart on load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (currentUser || !document.getElementById('loginScreen').classList.contains('hidden') === false) {
          renderAdvancedChart('radar');
        }
      }, 1000);
    });

    // ============================================
    // EXCEL NATIVE CHART CREATION (Office.js)
    // ============================================

    /**
     * Create a single chart of specified type
     */
    async function createChart(chartType, dataType) {
      try {
        if (!isOfficeReady || typeof Excel === 'undefined') {
          alert('Excel is not available. Please open this in Excel.');
          return;
        }

        await Excel.run(async (context) => {
          const sheets = context.workbook.worksheets;
          sheets.load('items/name');
          await context.sync();

          const dataSheet = sheets.items.find(s => s.name === 'Data');
          if (!dataSheet) {
            alert('No "Data" sheet found.');
            return;
          }

          const usedRange = dataSheet.getUsedRange();
          usedRange.load('rowCount');
          await context.sync();

          const rowCount = usedRange.rowCount;
          if (rowCount < 2) {
            alert('Data sheet appears empty.');
            return;
          }

          // Determine data columns based on dataType
          let dataRange;
          let chartTitle;
          switch (dataType) {
            case 'marketcap':
              dataRange = 'A1:A' + rowCount + ',D1:D' + rowCount;
              chartTitle = 'Market Cap Distribution';
              break;
            case 'price':
              dataRange = 'A1:B' + rowCount;
              chartTitle = 'Price Comparison (USD)';
              break;
            case 'change':
              dataRange = 'A1:A' + rowCount + ',C1:C' + rowCount;
              chartTitle = '24h Price Change (%)';
              break;
            default:
              dataRange = 'A1:B' + rowCount;
              chartTitle = 'Crypto Data';
          }

          // Map chart type
          let excelChartType;
          switch (chartType) {
            case 'pie':
              excelChartType = Excel.ChartType.pie;
              break;
            case 'bar':
              excelChartType = Excel.ChartType.columnClustered;
              break;
            case 'line':
              excelChartType = Excel.ChartType.line;
              break;
            default:
              excelChartType = Excel.ChartType.columnClustered;
          }

          // Create chart on active sheet
          const activeSheet = context.workbook.worksheets.getActiveWorksheet();
          const chart = activeSheet.charts.add(
            excelChartType,
            dataSheet.getRange(dataRange),
            Excel.ChartSeriesBy.columns
          );

          // Position at selection or default
          const selection = context.workbook.getSelectedRange();
          selection.load('address');
          await context.sync();

          chart.setPosition(selection);
          chart.height = 250;
          chart.width = 350;
          chart.title.text = chartTitle;
          chart.title.format.font.size = 14;
          chart.format.fill.setSolidColor('#1F2937');
          await context.sync();

          alert('Chart created: ' + chartTitle);
        });

      } catch (error) {
        console.error('[CRK] Chart error:', error);
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
