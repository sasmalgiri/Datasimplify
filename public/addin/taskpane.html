<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoReportKit</title>

  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    :root {
      --bg-dark: #111827;
      --bg-medium: #1F2937;
      --bg-light: #374151;
      --primary: #10B981;
      --primary-dark: #059669;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --error: #EF4444;
      --border: #374151;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: 14px;
    }

    .container { padding: 16px; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo { display: flex; align-items: center; gap: 10px; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-text h1 { font-size: 16px; font-weight: 600; }
    .logo-text p { font-size: 11px; color: var(--text-secondary); }

    .sign-out-btn {
      background: none; border: none;
      color: var(--text-muted); font-size: 12px; cursor: pointer;
    }
    .sign-out-btn:hover { color: var(--text-primary); }

    /* Sections */
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 12px; font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    /* Buttons */
    .btn {
      width: 100%; padding: 12px 16px;
      border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--bg-light); cursor: not-allowed; }

    /* Cards */
    .card {
      background: var(--bg-medium);
      border-radius: 8px; padding: 12px; margin-bottom: 8px;
    }

    /* Provider Row */
    .provider-row { display: flex; align-items: center; justify-content: space-between; }
    .provider-info { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .status-dot.connected { background: var(--primary); }
    .provider-name { font-weight: 500; }
    .provider-hint { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
    .provider-action { background: none; border: none; font-size: 12px; cursor: pointer; }
    .provider-action.connect { color: var(--primary); }
    .provider-action.remove { color: var(--error); }

    /* Quick Insert */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .quick-btn {
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px; padding: 10px;
      color: var(--text-primary); font-size: 12px;
      text-align: left; cursor: pointer; transition: all 0.2s;
    }
    .quick-btn:hover { border-color: var(--primary); background: var(--bg-light); }

    /* Function Reference */
    .func-item {
      background: var(--bg-medium);
      border-radius: 6px; padding: 10px; margin-bottom: 6px;
      font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;
    }
    .func-name { color: var(--primary); }
    .func-example { color: var(--text-muted); margin-top: 4px; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; text-align: center;
    }
    .login-logo {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, var(--primary), #6366F1);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; margin-bottom: 16px;
    }
    .login-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .login-subtitle { color: var(--text-secondary); font-size: 13px; margin-bottom: 24px; }
    .login-form { width: 100%; max-width: 280px; }
    .form-group { margin-bottom: 12px; text-align: left; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 10px 12px;
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 14px;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }
    .form-input::placeholder { color: var(--text-muted); }

    .error-msg {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error); padding: 10px;
      border-radius: 6px; font-size: 12px; margin-bottom: 12px;
    }
    .signup-link { margin-top: 16px; font-size: 12px; color: var(--text-muted); }
    .signup-link a { color: var(--primary); text-decoration: none; }

    /* Key Input */
    .key-input-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .key-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .key-input {
      flex: 1; padding: 8px 10px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary); font-size: 12px;
    }
    .key-input:focus { outline: none; border-color: var(--primary); }
    .key-btn { padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; }
    .key-btn-save { background: var(--primary); color: white; }
    .key-btn-cancel { background: var(--bg-light); color: var(--text-secondary); }
    .key-help { font-size: 11px; color: var(--text-muted); }
    .key-help a { color: var(--primary); text-decoration: none; }

    /* Loading */
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; color: var(--text-secondary);
    }
    .spinner {
      width: 24px; height: 24px;
      border: 2px solid var(--bg-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Footer */
    .footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
    .footer a { color: var(--primary); text-decoration: none; font-size: 13px; }
    .last-refresh { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 8px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingScreen" class="loading">
    <div class="spinner"></div>
    <span>Loading...</span>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen hidden">
    <div class="login-logo">ðŸ“Š</div>
    <h1 class="login-title">CryptoReportKit</h1>
    <p class="login-subtitle">Sign in to use CRK functions in Excel</p>

    <div class="login-form">
      <div id="loginError" class="error-msg hidden"></div>

      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="emailInput" class="form-input" placeholder="you@example.com">
      </div>

      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="passwordInput" class="form-input" placeholder="Enter your password">
      </div>

      <button id="loginBtn" class="btn btn-primary" onclick="handleLogin()">Sign In</button>

      <p class="signup-link">
        Don't have an account? <a href="https://cryptoreportkit.com/signup" target="_blank">Sign up</a>
      </p>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">ðŸ“Š</div>
        <div class="logo-text">
          <h1>CryptoReportKit</h1>
          <p id="userEmail">user@example.com</p>
        </div>
      </div>
      <button class="sign-out-btn" onclick="handleSignOut()">Sign out</button>
    </div>

    <!-- Refresh Button -->
    <div class="section">
      <button id="refreshBtn" class="btn btn-primary" onclick="handleRefresh()">â†» Refresh All Data</button>
      <p id="lastRefresh" class="last-refresh hidden">Last refresh: --</p>
    </div>

    <!-- API Keys -->
    <div class="section">
      <div class="section-title">API Keys (BYOK)</div>
      <div class="card">
        <div class="provider-row">
          <div class="provider-info">
            <div id="cgStatus" class="status-dot"></div>
            <span class="provider-name">CoinGecko</span>
            <span id="cgHint" class="provider-hint"></span>
          </div>
          <button id="cgAction" class="provider-action connect" onclick="toggleKeyInput()">Connect</button>
        </div>

        <div id="keyInputSection" class="key-input-section hidden">
          <div class="key-input-row">
            <input type="password" id="apiKeyInput" class="key-input" placeholder="CG-xxxxxxxxxxxxxxxxxxxx">
            <button class="key-btn key-btn-save" onclick="saveApiKey()">Save</button>
            <button class="key-btn key-btn-cancel" onclick="toggleKeyInput()">Cancel</button>
          </div>
          <p class="key-help">
            <a href="https://www.coingecko.com/en/api/pricing" target="_blank">Get free API key â†’</a>
          </p>
        </div>
      </div>
      <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
        Optional: Connect your own API key for higher rate limits
      </p>
    </div>

    <!-- Quick Insert -->
    <div class="section">
      <div class="section-title">Quick Insert</div>
      <div class="quick-grid">
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;bitcoin&quot;)')">BTC Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.PRICE(&quot;ethereum&quot;)')">ETH Price</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.CHANGE24H(&quot;bitcoin&quot;)')">BTC 24h %</button>
        <button class="quick-btn" onclick="insertFormula('=CRK.OHLCV(&quot;bitcoin&quot;,30)')">BTC OHLCV</button>
      </div>
    </div>

    <!-- Function Reference -->
    <div class="section">
      <div class="section-title">Available Functions</div>
      <div class="func-item">
        <span class="func-name">CRK.PRICE</span>(coin, [currency])
        <div class="func-example">=CRK.PRICE("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.CHANGE24H</span>(coin)
        <div class="func-example">=CRK.CHANGE24H("ethereum")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.MARKETCAP</span>(coin)
        <div class="func-example">=CRK.MARKETCAP("bitcoin")</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.OHLCV</span>(coin, [days])
        <div class="func-example">=CRK.OHLCV("bitcoin", 30)</div>
      </div>
      <div class="func-item">
        <span class="func-name">CRK.INFO</span>(coin, field)
        <div class="func-example">=CRK.INFO("bitcoin", "rank")</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <a href="https://cryptoreportkit.com/addin/docs" target="_blank">View all 30+ functions â†’</a>
    </div>
  </div>

  <script>
    const API_BASE = 'https://cryptoreportkit.com';
    let currentUser = null;
    let authToken = null;
    let isOfficeReady = false;

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('[CRK] Office ready:', info.host);
      isOfficeReady = true;
      init();
    });

    // Fallback for testing outside Excel
    setTimeout(() => {
      if (!isOfficeReady) {
        console.log('[CRK] Running outside Office');
        init();
      }
    }, 2000);

    async function init() {
      // Check for stored token
      try {
        if (typeof OfficeRuntime !== 'undefined') {
          authToken = await OfficeRuntime.storage.getItem('crk_auth_token');
          const email = await OfficeRuntime.storage.getItem('crk_user_email');
          if (authToken && email) currentUser = { email };
        }
      } catch (e) {
        authToken = localStorage.getItem('crk_auth_token');
        const email = localStorage.getItem('crk_user_email');
        if (authToken && email) currentUser = { email };
      }

      document.getElementById('loadingScreen').classList.add('hidden');
      if (currentUser) {
        showMainApp();
        loadProviderStatus();
      } else {
        showLoginScreen();
      }
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    async function handleLogin() {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');

      if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Signing in...';
      errorDiv.classList.add('hidden');

      try {
        const response = await fetch(API_BASE + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Login failed');

        authToken = data.access_token;
        currentUser = { email: data.email || email };

        try {
          if (typeof OfficeRuntime !== 'undefined') {
            await OfficeRuntime.storage.setItem('crk_auth_token', authToken);
            await OfficeRuntime.storage.setItem('crk_user_email', currentUser.email);
          }
        } catch (e) {
          localStorage.setItem('crk_auth_token', authToken);
          localStorage.setItem('crk_user_email', currentUser.email);
        }

        showMainApp();
        loadProviderStatus();
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleSignOut() {
      try {
        if (typeof OfficeRuntime !== 'undefined') {
          await OfficeRuntime.storage.removeItem('crk_auth_token');
          await OfficeRuntime.storage.removeItem('crk_user_email');
        }
      } catch (e) {}
      localStorage.removeItem('crk_auth_token');
      localStorage.removeItem('crk_user_email');
      currentUser = null;
      authToken = null;
      showLoginScreen();
    }

    async function loadProviderStatus() {
      try {
        const response = await fetch(API_BASE + '/api/v1/keys/coingecko', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.ok) {
          const data = await response.json();
          const statusDot = document.getElementById('cgStatus');
          const hint = document.getElementById('cgHint');
          const action = document.getElementById('cgAction');

          if (data.connected) {
            statusDot.classList.add('connected');
            hint.textContent = 'â€¢â€¢â€¢â€¢' + (data.hint || '');
            action.textContent = 'Remove';
            action.className = 'provider-action remove';
            action.onclick = removeApiKey;
          } else {
            statusDot.classList.remove('connected');
            hint.textContent = '';
            action.textContent = 'Connect';
            action.className = 'provider-action connect';
            action.onclick = toggleKeyInput;
          }
        }
      } catch (error) {
        console.error('[CRK] Error loading provider status:', error);
      }
    }

    function toggleKeyInput() {
      const section = document.getElementById('keyInputSection');
      section.classList.toggle('hidden');
      document.getElementById('apiKeyInput').value = '';
    }

    async function saveApiKey() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) { alert('Please enter an API key'); return; }

      try {
        const response = await fetch(API_BASE + '/api/v1/keys/coingecko', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          body: JSON.stringify({ apiKey })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to save key');
        }
        toggleKeyInput();
        loadProviderStatus();
      } catch (error) {
        alert(error.message);
      }
    }

    async function removeApiKey() {
      if (!confirm('Remove your CoinGecko API key?')) return;
      try {
        await fetch(API_BASE + '/api/v1/keys/coingecko', {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        loadProviderStatus();
      } catch (error) {
        console.error('[CRK] Error removing key:', error);
      }
    }

    async function handleRefresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        if (isOfficeReady && typeof Excel !== 'undefined') {
          await Excel.run(async (context) => {
            context.workbook.application.calculate('Full');
            await context.sync();
          });
        }
        const lastRefresh = document.getElementById('lastRefresh');
        lastRefresh.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
        lastRefresh.classList.remove('hidden');
      } catch (error) {
        console.error('[CRK] Refresh error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'â†» Refresh All Data';
      }
    }

    async function insertFormula(formula) {
      if (isOfficeReady && typeof Excel !== 'undefined') {
        try {
          await Excel.run(async (context) => {
            const range = context.workbook.getSelectedRange();
            range.formulas = [[formula]];
            await context.sync();
          });
        } catch (error) {
          await navigator.clipboard.writeText(formula);
          alert('Formula copied to clipboard: ' + formula);
        }
      } else {
        await navigator.clipboard.writeText(formula);
        alert('Formula copied to clipboard: ' + formula);
      }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', () => {
      ['emailInput', 'passwordInput'].forEach(id => {
        document.getElementById(id)?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleLogin();
        });
      });
    });
  </script>
</body>
</html>
