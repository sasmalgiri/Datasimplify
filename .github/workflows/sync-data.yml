# Data Sync Workflow
# Automatically syncs cryptocurrency data to Supabase cache
# Reduces CoinGecko API rate limiting by pre-populating data

name: Sync Crypto Data

on:
  schedule:
    # CoinGecko sync every 5 minutes (primary cache source)
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - coingecko
          - market
          - defi
          - sentiment
          - whales
          - onchain

jobs:
  # CoinGecko sync runs every 5 minutes
  sync-coingecko:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.sync_type == 'coingecko' || github.event.inputs.sync_type == 'all'))
    steps:
      - name: Sync CoinGecko Market Data
        run: |
          echo "ü™ô Syncing CoinGecko data..."
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "${{ secrets.SITE_URL }}/api/sync?type=coingecko&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 120 \
            --retry 2 \
            --retry-delay 30)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"

          if [ "$http_code" = "200" ]; then
            echo "‚úÖ CoinGecko sync complete"
          else
            echo "‚ö†Ô∏è CoinGecko sync returned $http_code (may be rate limited)"
          fi

  # Full sync runs every 15 minutes (at 0, 15, 30, 45)
  sync-full:
    runs-on: ubuntu-latest
    if: (github.event_name == 'schedule' && contains('0,15,30,45', format('{0}', github.run_number))) || (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'all')
    steps:
      - name: Sync Market Data (Binance)
        run: |
          echo "üìä Syncing Binance market data..."
          curl -s -X GET "${{ secrets.SITE_URL }}/api/sync?type=market&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --retry 2 \
            --retry-delay 10
          echo "‚úÖ Market sync complete"

      - name: Sync DeFi Data
        run: |
          echo "üè¶ Syncing DeFi data..."
          curl -s -X GET "${{ secrets.SITE_URL }}/api/sync?type=defi&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --retry 2 \
            --retry-delay 10
          echo "‚úÖ DeFi sync complete"

      - name: Sync Sentiment Data
        run: |
          echo "üí¨ Syncing sentiment data..."
          curl -s -X GET "${{ secrets.SITE_URL }}/api/sync?type=sentiment&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 120 \
            --retry 2 \
            --retry-delay 10
          echo "‚úÖ Sentiment sync complete"

      - name: Sync Whale Data
        run: |
          echo "üêã Syncing whale data..."
          curl -s -X GET "${{ secrets.SITE_URL }}/api/sync?type=whales&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --retry 2 \
            --retry-delay 10
          echo "‚úÖ Whale sync complete"

      - name: Sync On-Chain Data
        run: |
          echo "‚õìÔ∏è Syncing on-chain data..."
          curl -s -X GET "${{ secrets.SITE_URL }}/api/sync?type=onchain&secret=${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --retry 2 \
            --retry-delay 10
          echo "‚úÖ On-chain sync complete"

      - name: Log Completion
        run: echo "üéâ All syncs completed at $(date -u)"
